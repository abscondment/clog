<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom"><title>Wine, Water, and Blood</title><subtitle>Three Planes of Thought Which to Sail</subtitle><link href="http://threebrothers.org/brendan/blog/atom.xml" rel="self" /><link href="http://threebrothers.org/brendan/" /><id>tag:threebrothers.org,2010-01-07:/brendan/blog</id><updated>2010-05-06T15:31:30-08:00</updated><author><name>Brendan Ribera</name><email>brendan.ribera+blogatom@gmail.com</email></author><entry><title>Encoding iPad Video from Linux</title><link href="http://threebrothers.org/brendan/blog/encoding-ipad-video-from-linux/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2010-05-04:/brendan/blog/encoding-ipad-video-from-linux</id><updated>2010-05-04T22:59:55.0-08:00</updated><summary><![CDATA[
Preamble I hesitate to publish these instructions because h.264 is patent-encumbered and dangerous, and I don't want to contribute to its proliferation. But the steps here are general enough to be useful in many other situations, and interesting enough to merit discussion. The Goal I was given an iPad. We own several DVDs t...]]>
</summary><content type="html"><![CDATA[
<h2>Preamble</h2>

<p>I hesitate to publish these instructions because <a href="http://www.osnews.com/story/23236/Why_Our_Civilization_s_Video_Art_and_Culture_is_Threatened_by_the_MPEG-LA">h.264 is patent-encumbered and dangerous</a>, and I don't want to contribute to its proliferation. But the steps here are general enough to be useful in many other situations, and interesting enough to merit discussion.</p>

<h2>The Goal</h2>

<p>I was given an iPad. We own several DVDs that my son Ezra loves to watch, and I would like to let him watch them on the iPad. I selected <em>WALL&bull;E</em> and tried to use <code>dvd::rip</code> (via Ubuntu's vanilla <code>dvdrip</code> package), but it failed miserably. It 'read' 100 titles, each of which really turned out to be the movie with its chapters in the wrong order.</p>

<h2>World Domination in Four Easy Steps</h2>

<p>Because the point-and-click method had failed, I turned to the command line. I never should have left, really. Here's the solution I found after much digging and trial-and-error.</p>

<ul>
<li>Extract the VOBs</li>
<li>Concatenate the VOBs</li>
<li>Build a better ffmpeg</li>
<li>Encode!</li>
</ul>

<h3>Extract the VOBs</h3>

<p>The first step is to figure out exactly what we want to extract, and then to grab it. I used <code>dvdbackup</code> for this.</p>

<pre><code># Show info about this disk
brendan@ishmael:~/Videos$ dvdbackup -I | less
# Output indicated that the main Title Set is 3
brendan@ishmael:~/Videos$ dvdbackup -T 3
brendan@ishmael:~/Videos$ tree -s WALL_E/
WALL_E/
`-- [       4096]  VIDEO_TS
    |-- [     163840]  VTS_03_0.BUP
    |-- [     163840]  VTS_03_0.IFO
    |-- [  170770432]  VTS_03_0.VOB
    |-- [ 1073739776]  VTS_03_1.VOB
    |-- [ 1073739776]  VTS_03_2.VOB
    |-- [ 1073739776]  VTS_03_3.VOB
    |-- [ 1073739776]  VTS_03_4.VOB
    |-- [ 1073739776]  VTS_03_5.VOB
    `-- [  111591424]  VTS_03_6.VOB
</code></pre>

<h3>Concatenate the VOBs</h3>

<p>These files are pretty boring, but they can be concatenated since they're basically just MPEG streams. My initial approach was to cat them together and pipe the result to ffmpeg, which took up no additional disk space and had the virtue of lazily deferring IO while the encoder churned.</p>

<pre><code>cat *.VOB | ffmpeg -y -i - &lt;em&gt;...&lt;/em&gt;
</code></pre>

<p>As nice as this plan was, I couldn't get it to work. My audio stream would disappear, and I couldn't figure out how to tell ffmpeg that it existed. The end result was beautiful video with no sound.</p>

<p>Instead, I piped them to one big file and operated on that. I also omitted the 0 file, since it turned out to be the DVD menu animations.</p>

<pre><code>rm VTS_03_0.VOB
for x in *.VOB; do cat $x &gt;&gt; walle.vob; done
</code></pre>

<h3>Build a better ffmpeg</h3>

<p>Because my goal was to use this on my iPad, I had rather nonstandard requirements: h.264 video and AAC audio with an MPEG-4 container. As I mentioned before, these formats are far from ideal &ndash; use OGG/Theora when you can. Presumably because they are non-free, the default Ubuntu ffmpeg package doesn't include these encoders. You'll need to replace it.</p>

<p>Follow this <a href="http://ubuntuforums.org/showpost.php?p=8345112&amp;postcount=636">helpful tutorial to build ffmpeg</a> and various encoders from source. I enabled all of the options.</p>

<h3>Encode!</h3>

<p>The <a href="http://www.apple.com/ipad/specs/">iPad specifications</a> indicate that it can do h.264 video up to 720p at 30fps with AAC sound at 160Kbps, 48kHz. To achieve this, I did a 2-pass encoding based on an <a href="http://rob.opendot.cl/index.php/useful-stuff/ffmpeg-x264-encoding-guide/">encoding guide</a> and a list of <a href="http://rodrigopolo.com/ffmpeg/cheats.html">ffmpeg cheats</a>. I also did a lot of trial and error encoding, and my most pertinent piece of advice is this: test on a small VOB first. Fail quickly.</p>

<p><code style='display:block;padding:1em 2em;background-color:#efefef;border-color:#ddd;border-style: solid;border-width: 1px 0px;'>
  ffmpeg -y -i walle.vob -r 30000/1001 -b 2M -bt 4M -pass 1 -vcodec libx264 -vpre fastfirstpass -threads 0 -an -f mp4 /dev/null
  <br/><br/>
  ffmpeg -y -i walle.vob -r 30000/1001 -b 2M -bt 4M -pass 2 -vcodec libx264 -vpre hq -threads 0 -map 0.0:0.0 -map 0.2:0.1 -acodec libfaac -ac 2 -ab 160k -ar 48000 walle.mp4
</code></p>

<p>Outside of the typical ffmpeg files/encoders/rates, there are a few interesting settings:</p>

<ul>
<li><strong>-r 30000/1001</strong>: set the frame rate to ~30fps</li>
<li><strong>-pass &lt;N&gt;</strong>: indicate which pass we're doing</li>
<li><strong>-vpre &lt;value&gt;</strong>: indicate which libx264 preset file to apply</li>
<li><strong>-threads 0</strong>: let the encoder choose how many threads to use based on your hardware. Set this to utilize multicore/proc.</li>
<li><strong>-an</strong>: disable audio, since the first pass only looks at video</li>
<li><strong>-f mp4 /dev/null</strong>: set type to mp4 and output to /dev/null, since the first pass stores its statistics in secondary files and the actual video output should be thrown away.</li>
<li><strong>-map 0.0:0.0 -map 0.2:0.1</strong>: switch to the English audio stream, which was located in the 0.2 stream instead of the normal 0.1. To figure out which was which, I did variations of <code>ffmpeg -y -i walle.vob -vn -acodec libfaac -ac 2 -ab 160k -ar 48000 -map 0.2:0.1 walle.aac</code> (extracting just audio) until I found the right stream.</li>
</ul>

<p>This produces a fairly high quality DVD rip that should be iPad compatible. Unfortunately, you'll need to leave the wonderful world of Linux to actually put the file on your iPad. Don't you just feel dirty doing this? I know I do. In lieu of that, you could host it on a local webserver. I can stream this bitrate over WiFi via nginx perfectly well.</p>

<h2>Closing Thoughts</h2>

<p>The file I produced is currently not iPhone compatible. From what I can tell, the iPhone can only handle <a href="http://www.ilounge.com/index.php/articles/comments/the-complete-guide-to-ipod-video-formats-and-display-resolutions/">640x480 video at 1.5mbps</a>. You could do one of three things: tune the ffmpeg parameters to produce a video that'll work on both, produce one separate file for each device, or do what I did and eschew the the low resolution option.</p>

<p>I'd like to figure out how to do this encoding on the fly. <code>hdparm</code> says my DVD transfer speeds clock in around 2-3MB/sec, which should stay ahead of the CPU during encoding. It would be wonderful if the only additional disk space taken up by this process were for intermediate first-pass statistics and the final encoded video. As things happened, I copied the files once from CD and again to concatenate them. That's less than ideal.</p>

<p>I'd also like to showcase an open codec like OGG/Theora, since I strongly believe in that cause. Doing that now can be an exercise for the reader, and it shouldn't be too hard; it's just a matter of finding the correct ffmpeg parameters.</p>
]]>
</content></entry><entry><title>Removing the Cast</title><link href="http://threebrothers.org/brendan/blog/removing-the-cast/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2010-04-23:/brendan/blog/removing-the-cast</id><updated>2010-04-23T22:20:08.0-08:00</updated><summary><![CDATA[
Three months ago, I broke my right hand while biking to work. I made a questionable decision involving slippery metal grating on the University Bridge, and found myself doing a not-so-graceful, 20 MPH handstand in the way of traffic. I was incredibly fortunate to have only sustained a broken hand. My arm was in a cast for a...]]>
</summary><content type="html"><![CDATA[
<p>Three months ago, I broke my right hand while biking to work. I made a questionable decision involving <a href="http://www.historylink.org/index.cfm?DisplayPage=output.cfm&amp;file_id=3139">slippery metal grating on the University Bridge</a>, and found myself doing a not-so-graceful, 20 <abbr title='Miles-per-hour'>MPH</abbr> handstand in the way of traffic. I was incredibly fortunate to have only sustained a broken hand.</p>

<p>My arm was in a cast for approximately five weeks. The nature of this situation was, as you can imagine, <em>really</em> obnoxious. The aftermath of cast-wearing proved equally obnoxious: with nothing to do, muscles atrophy; joints and tendons stiffen. I found myself training to make a fist or to be strong enough to chop carrots. It was five more weeks before my wrist and hand were strong enough for me to ride to work.</p>

<div class='rightImage'>
  <img src='http://threebrothers.org/brendan/images/broken-hand-sketch.png' alt='Me with a cast' />
</div>

<p>In these weeks of recovery, I realized just how much <em>immobilization</em> had contributed to my weakened state. Small, anonymous actions are constantly reinforcing our ability to move. Small, frustrating exercises littered the path back to full recovery. As I rode the bus home yet again (while practicing flexion exercises that made me look insane), this struck me: Your work environment can be a cast, or it can be a bicycle.</p>

<p>Part of what I love about small companies is that they make the bicycle the norm. There's little tolerance for inactivity or wasted motion &ndash; you must be habitually productive, or you fall off. Biking to work doesn't only get you there; it makes you stronger and fitter, too. The startups that I've worked with have all had cultures that reinforce, stretch, and strengthen their employees.</p>

<p>Autonomy, creativity, and low-friction communication. My goal is to always work in an environment like this. And I never want to <a href="http://www.wetherobots.com/2008/06/16/meeting-time/">feel like this</a> again.</p>

<p>Challenge yourself &ndash; learn a new <a href="http://clojure.org">language</a>, a new <a href="http://lucene.apache.org/mahout/taste.html">technology</a>, or a new <a href="http://projecteuler.net/index.php?section=problems&amp;id=66">mathematical concept</a>. Think about <a href="http://www.paulgraham.com/organic.html">seeing the problems around you</a>. Get on the bicycle and ride. As for me, I'm excited to now be doing this <a href="http://www.urbanspoon.com/about">at Urbanspoon</a>.</p>
]]>
</content></entry><entry><title>Android Impressions</title><link href="http://threebrothers.org/brendan/blog/android-impressions/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2010-04-13:/brendan/blog/android-impressions</id><updated>2010-04-13T00:30:36.0-08:00</updated><summary><![CDATA[
 Fitter, happier, more pastries. Thanks to my latest aquatic shenanigans, I spent a week playing with a Nexus One. Here are my impressions. If I make any comparisons that lack context, assume they are drawn in relation to the iPhone. Product quality Hardware Negative: Only 4.5GB of space by default (512MB flash + 4GB SD) Ge...]]>
</summary><content type="html"><![CDATA[
<div class='rightImage'>
  <img src='http://threebrothers.org/brendan/images/android-baked-goods.jpg' title='Credit: http://www.flickr.com/photos/niallkennedy/4118685804/' alt='Credit: http://www.flickr.com/photos/niallkennedy/4118685804/' />
  <br/>
  <em>Fitter, happier, more pastries.</em>
</div>

<p>Thanks to my <a href="http://threebrothers.org/brendan/blog/iphone-toilet-debacle-redux-backlight/">latest aquatic shenanigans</a>, I spent a week playing with a Nexus One. Here are my impressions. If I make any comparisons that lack context, assume they are drawn in relation to the iPhone.</p>

<h2>Product quality</h2>

<h3>Hardware</h3>

<p>Negative:</p>

<ul>
<li>Only 4.5GB of space by default (512MB flash + 4GB SD)</li>
<li>Generally poorer battery performance than the iPhone</li>
<li>Five buttons &ndash; <abbr title='Keep it simple, stupid!'>KISS</abbr></li>
</ul>

<p>Positive:</p>

<ul>
<li>Removable battery (I can't stress enough what a boon this is)</li>
<li>Swappable micro SD card</li>
<li>Screen is larger and higher resolution</li>
<li>5 megapixel camera with flash (compare to the iPhone's flashless 3 megapixel)</li>
<li>1GHz processor with 512MB RAM (600MHz/256MB for a 3GS)</li>
</ul>

<p>The Nexus One has a substantial, polished feel. It's not exactly <em>sexy</em> in the ways the iPhone is, but it certainly doesn't feel like a cheap imitation. The specifications are pretty substantial, too. Given the superior hardware, it's understandable that battery life is inferior. Who knows about either phone's long-term battery performance. If the lithium-ion gods frown on you after a few months, you'll be forking over $79 with Apple and only $25 with Google.</p>

<h3>Software</h3>

<p>Negative:</p>

<ul>
<li>Inferior and slightly confusing UI</li>
<li>Inferior app selection</li>
<li>Browser feels clunky compared to Safari</li>
</ul>

<p>Positive:</p>

<ul>
<li>Android OS is open source</li>
<li>Android Market is growing</li>
<li>Background apps</li>
<li>Apps are cloud-oriented; no more syncing through slow, clunky iTunes</li>
</ul>

<div class='rightImage'>
  <img src='http://threebrothers.org/brendan/images/nexus-one-buttons.jpg' title='Credit: http://www.flickr.com/photos/naka7a/4356824760/' alt='Credit: http://www.flickr.com/photos/naka7a/4356824760/' />
  <br/>
  <em>Look at those wee, beady buttons.</em>
</div>

<p>I found the UI to be the biggest barrier for me. I disliked the Nexus One's <a href="http://www.youtube.com/watch?v=TPMS6tGOACo">pentavirate</a> of buttons before I had even turned it on. 'Back' and 'Search' are given permanent hardware real estate despite their limited applicability &ndash; many (if not most) apps have no use for them. 'Home' is present, but given a middle position with no tactile means of locating it &ndash; it's hard to switch apps in the dark.</p>

<p>And then there's the 'Menu' button &ndash; this is where the biggest problems lie. I'm an engineer, but I have a <a href="http://ischool.uw.edu/informatics/prospective/at_uw.aspx">degree in Informatics</a> &ndash; I have enough interface design and usability knowledge to cause trouble. Here's what I see in the 'Menu' button: the iPhone makes good use of <em>affordances</em>; Android does not. What do I mean?</p>

<blockquote>
  <p><a name='rn1'></a><em>An <strong>affordance</strong> is an aspect of an object that makes it obvious how the object is to be used. [&hellip;] Affordances must be visible to aid interpretation.</em><sup><a href='#fn1'>1</a></sup></p>
</blockquote>

<p>The 'Menu' button doesn't make its functions obvious. If you press it, a menu comes up; if you hold it down, the on-screen keyboard appears. Both functions could be loosely associated with the button's graphic, but one would never guess them by simply looking at the button. This is minor, though; one can figure this functionality out quickly, and once it's known, that's that. What is bad is the precedent that this button sets for applications.</p>

<p>The Android developer guide prefaces its section on <a href="http://developer.android.com/guide/practices/ui_guidelines/menu_design.html">Menu Design Guidelines</a> with this assertion:</p>

<blockquote>
  <p><em>A menu holds a set of commands (user actions) that are normally hidden, and are accessible by a button, key, or gesture.</em></p>
</blockquote>

<p>By convention, <strong>every Android interface has broken affordances</strong>. Apps are asked to obscure large portions of functionality in a hidden menu. Contrast this with Apple's in-depth <a href="http://developer.apple.com/iphone/library/documentation/UserExperience/Conceptual/MobileHIG/PrinciplesAndCharacteristics/PrinciplesAndCharacteristics.html#//apple_ref/doc/uid/TP40006556-CH7-SW1">iPhone Human Interface Guidelines</a>:</p>

<blockquote>
  <p><em>Presenting choices to the user [&hellip;] allows them to concentrate on accomplishing tasks with your application, instead of remembering how to operate it.</em></p>
</blockquote>

<p>People tout simplicity as being the aspect of Apple's design that makes it superior. What they're trying to articulate is that the consistent application of good affordances allows users to approach every interface with knowledge about how to use it. The UI is not only simple &ndash; it's <em>understood</em>. Apple's defaults are a shared set of <em>visible</em> controls &ndash; (almost) everything that can be done is displayed using a common language. Android causes apps to fragment the user's knowledge &mdash; you have to individually <em>discover</em> and then <em>remember</em> exactly what can be done by every app because much of the functionality is invisible.</p>

<h2>For consumers and developers</h2>

<div class='rightImage'>
  <img src='http://threebrothers.org/brendan/images/babbage-engine.jpg' alt='Babbage Analytical Engine' />
  <br/>
  <em>The Apple Analytical Engine<br />only accepts papyrus punch cards.</em>
</div>

<p>I've spent a bit of time talking about what I perceive to be the biggest weakness in the Android platform. This section is <em>much</em> friendlier towards Android.</p>

<p>Android is a platform for hackers. It's open source, and can be hacked using any <abbr title='Java Virtual Machine'>JVM</abbr> language on any development platform. The iPhone requires you to purchase an expensive Apple computer, use only the <a href="http://daringfireball.net/2010/04/iphone_agreement_bans_flash_compiler">approved tools/languages</a> , and pay $99/year to be part of the developer program. Android phones also come unlocked &ndash; that is, you can use them with any network.</p>

<p>I've heard it suggested that Apple's closed platform will lead to better quality and a tighter control on the market. These sound like great things <em>for Apple</em>. As consumers, we don't necessarily want Apple to have control, and we don't want to be hogtied to AT&amp;T &ndash; we want competition to force continued innovation.</p>

<p>There are copious blog posts discussing the negative ramifications of Apple's closed platform. If you've read none of them, <em><a href="http://diveintomark.org/archives/2010/01/29/tinkerers-sunset">Tinkerer's Sunset</a></em> and the <a href="http://al3x.net/2010/01/28/ipad.html">post of Alex Payne's</a> that inspired it (or at the very least inspired the title) are good start. I don't have much to add here. Limiting developers' tools or languages stifles innovation. The inverted version is what attracts me to Android: granting freedom to developers promotes innovation.</p>

<h2>Conclusion</h2>

<p>The Nexus One hardware and the openness of the Android platform outweigh any UI advantage held by the iPhone. As this assertion comes from a guy who spends upwards of 8 hours a day inside emacs or a Linux terminal, it should be taken with a few grains of salt. When my contract with AT&amp;T is up, however, I'll be looking to the Android market for my next phone. And I'd love to get ahold of an Android tablet.</p>

<hr/>

<p><sup>1</sup> <span class='fn'>Mary Beth Rosson and John M. Carroll, <em><a href='http://books.google.com/books?id=RRC9IODz4VsC&amp;pg=PA124'>Usability Engineering</a></em> (Morgan Kaufmann, 2002), 124. <a name='fn1' href='#rn1'>&crarr;</a></span></p>
]]>
</content></entry><entry><title>iPhone Toilet Debacle Redux: The Backlight</title><link href="http://threebrothers.org/brendan/blog/iphone-toilet-debacle-redux-backlight/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2010-03-29:/brendan/blog/iphone-toilet-debacle-redux-backlight</id><updated>2010-03-29T13:43:21.0-08:00</updated><summary><![CDATA[
Last Tuesday marked the 485th day since I dropped my first-generation iPhone in the toilet. I commemorated the occasion by setting my 3G in a precarious position on the edge of the bathroom sink, and then watching in horror from the shower as my almost-2-year-old came in and rammed it with a truck. Right into the toilet. No...]]>
</summary><content type="html"><![CDATA[
<p>Last Tuesday marked the 485<sup>th</sup> day since I dropped my first-generation iPhone in the toilet. I commemorated the occasion by setting my 3G in a precarious position on the edge of the bathroom sink, and then watching in horror from the shower as my almost-2-year-old came in and rammed it with a truck. Right into the toilet.</p>

<div class='rightImage'><img src='http://threebrothers.org/brendan/images/cat-toilet.jpg' alt='' title='Credit: http://www.flickr.com/photos/harvardavenue/79221382/' /><br/><em>No!!!! My Phone!!!!</em></div>

<p>You've probably experienced the sinking feeling that accompanies circumstances such as this one. My wife fished the phone out and I immediately shut it down, dried it off, and stuck it into a glass full of rice. What a crappy situation &ndash; pun indended. I began figuring out how I would justify buying a <em>third</em> ridiculously expensive phone-computer given my complete inability to protect said device.</p>

<p>Over the next few days, I discovered that the phone was still largely functional. The backlight was completely dead, but I could receive calls, connect to WiFi, and (most importantly) the touchscreen still worked. Adjusting brightness settings did nothing for the backlight. My tests were brief, and I placed the phone back in its rice cocoon afterwards with hopes that more moisture would be absorbed.</p>

<h2>Fixing the backlight</h2>

<p>Fortunately, Phil hadn't yet <a href="http://thebogles.com/blog/2010/04/joining-google/">left for Google</a>, and he found some interesting claims about a method to fix a backlight that had died a watery death. The steps were:</p>

<ol>
<li>Backup the phone</li>
<li>Perform a factory restore</li>
<li>Adjust the brightness settings</li>
</ol>

<p>I was skeptical, but after 5 days of no progress I thought it was worth a shot. Because I don't really ever leave Linux, I hadn't yet updated to the 3.1.3 OS release. I did this upgrade in lieu of the 'factory restore' step, and (after completing step 3) was delighted to find my backlight fully functional! Major kudos to Phil for locating this information.</p>

<p>It's interesting to engage in wild speculation about the hardware/software details that could lead to this. Perhaps some hardware state was corrupted by a short, and the resulting value had no valid meaning for the backlight. Normal brightness adjustment operated on the value, but didn't change enough of it to make it meaningful again (perhaps bit operations on an int that was saved as much larger than it's theoretical max &ndash; only operating on the lower order bits). Part of the upgrade/restore procedure writes sane defaults into these locations, restoring functionality. Who knows.</p>

<h3>Coda</h3>

<p>In the intervening days between my phone's death and revival, I got to play with a Nexus One from work. I'll write a post comparing the two soon. And I'm <em>really</em> glad that I don't have to shell out for a new phone... yet.</p>
]]>
</content></entry><entry><title>Memory and Ruby :symbols</title><link href="http://threebrothers.org/brendan/blog/memory-and-ruby-symbols/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2010-03-01:/brendan/blog/memory-and-ruby-symbols</id><updated>2010-03-01T21:32:32.0-08:00</updated><summary><![CDATA[
Ruby provides a really flexible and sugary syntax. A lot can be expressed in one little snippet, and the same functionality can often be rewritten in many different ways. In this post, I'd like to focus on some potentially dangerous properties of one particular piece of Ruby: the Symbol. First, compare these two lines: (1) ...]]>
</summary><content type="html"><![CDATA[
<p>Ruby provides a really flexible and sugary syntax. A lot can be expressed in one little snippet, and the same functionality can often be <a href='http://refactormycode.com/codes/2-ruby-simple-loop' rel='nofollow external'>rewritten in many different ways</a>. In this post, I'd like to focus on some potentially dangerous properties of one particular piece of Ruby: the <a href='http://ruby-doc.org/core/classes/Symbol.html' rel='nofollow external'>Symbol</a>.</p>

<p>First, compare these two lines:</p>

<pre><code>(1) {:foo  =&gt; 'bar', :qux  =&gt; 'quux'}
(2) {'foo' =&gt; 'bar', 'qux' =&gt; 'quux'}
</code></pre>

<p>I'd say that Ruby developers default to (1) &ndash; at least, most Ruby code that I've worked with tends to favor that variant. This seems to be in part a matter of aesthetic taste, and a subtle way to differentiate between a map's keys and values. Sending a hash of symbolized keys to a method has become a fairly common way of implementing complex options &ndash; it's <a href='http://api.rubyonrails.org/classes/ActiveRecord/Base.html#M002263' rel='nofollow external'>prevalent in Rails</a>. Rails uses this construct so often that it adds <a href='http://api.rubyonrails.org/classes/ActiveSupport/CoreExtensions/Hash/Keys.html#M001190' rel='nofollow external'>extensions to the native <code>Hash</code></a> object to facilitate turning their <code>String</code> keys into <code>Symbols</code> and <em>vice versa</em>.</p>

<h2>Symbols to the rescue!</h2>

<p>There are some really common situations where (1) is the best option. A variation of <a href='http://glu.ttono.us/articles/2005/08/19/understanding-ruby-symbols' rel='external'>the canonical example</a> follows: Say you're creating thousands of hashes to represent a common JSON object &ndash; a temperature reading. They all have the same key structure, but the data differ.</p>

<pre><code>sea = {'lat' =&gt; 47.53, 'lon' =&gt; 122.30, 'temp' =&gt; 15.0}
sf  = {'lat' =&gt; 37.79, 'lon' =&gt; 122.41, 'temp' =&gt; 25.0}

puts sea.keys[0] == sf.keys[0] # true
puts sea.keys[0].object_id     # 86288110
puts sf.keys[0].object_id      # 86345290
</code></pre>

<p>So it's 15&deg;C in Seattle and 25&deg;C in San Francisco. Typical. What's more interesting is that although your keys are equal, they are two different <code>String</code> objects. With 1,000,000 such hashes, you're carrying around 3,000,000 strings that take up a lot more space than the <code>Float</code> entries.</p>

<p>Symbols solve this issue. At the C level of Ruby, each symbol maps to an unsigned integer &ndash; the <a href='http://en.wikipedia.org/wiki/Symbol_table' rel='nofollow external'>symbol table</a> has one entry per symbol, and the entries exist as long as the process lives.</p>

<h2>Wait, why is that still lying around?</h2>

<p>Symbols are tiny and combine identity with equality, but <strong>they're never garbage collected</strong>. That's how the symbol table implementation works. So, replacing 3,000,000 Strings with 3 Symbols is a great improvement. But in a long-running process that does a lot of GC and uses random, unique keys, symbols can hurt.</p>

<p>To illustrate the problem, I grepped through the iLike codebase for unique symbols. I stored them as Strings only, read the current memory usage, and then converted them all to Symbols using <code>to_sym</code>. The isolated increase in memory usage was ~<strong>1.2MB</strong> &ndash; and this test can't even find symbols created programmatically!</p>

<p>Now, that figure represents &lt;1% of the memory used by a typical process of ours. But that consumption adds to Ruby's large low water mark for memory. If our application created symbols for arbitrary user input, we could easily choke a box into swapdeath. Incidentally, this is one reason why <code>HashWithIndifferentAccess</code> stores its keys internally as Strings &ndash; each Rails request creates a HWIA with all of the query parameters and GCs it later. Automatically converting query parameter names to symbols would create a vector for an easy <acronym title='Denial of Service'>DOS</acronym> attack.</p>

<h2>Guidelines</h2>

<p>So, how should Symbols be used?</p>

<ul>
<li>Common values that are used often/repeatedly for <em>identity</em> (i.e. our temperature hash keys) should be Symbols. They're all about identity.</li>
<li>Unique, high cardinality values or values that will be discarded should not be Symbols. They need to be garbage collected.</li>
</ul>
]]>
</content></entry><entry><title>Disabling Flash in Chrome, and Other Tricks</title><link href="http://threebrothers.org/brendan/blog/disabling-flash-in-chrome/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2010-02-25:/brendan/blog/disabling-flash-in-chrome</id><updated>2010-02-25T20:48:12.0-08:00</updated><summary><![CDATA[
I just learned that there is a handy switch one can pass while launching Chrome to bypass the plugin architecture: google-chrome --disable-plugins Previously I had resorted to moving libflashplayer.so or removing read access from it, but this is a much more controlled method. The are a ton of other Chrome switches that I on...]]>
</summary><content type="html"><![CDATA[
<p>I just learned that there is a handy switch one can pass while launching Chrome to bypass the plugin architecture:</p>

<pre><code>google-chrome --disable-plugins
</code></pre>

<p>Previously I had resorted to moving <code>libflashplayer.so</code> or removing read access from it, but this is a much more controlled method.</p>

<p>The are a ton of <a href="http://www.google.com/codesearch/p?hl=en#h0RrPvyPu-c/chrome/common/chrome_switches.cc">other Chrome switches</a> that I only found by browsing the source &ndash; good thing it's available. Among them is <code>allow-file-access-from-files</code>, which would have come in handy yesterday.</p>
]]>
</content></entry><entry><title>Closures in Java, Ruby, and Duby</title><link href="http://threebrothers.org/brendan/blog/closures-in-java-ruby-and-duby/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2010-02-05:/brendan/blog/closures-in-java-ruby-and-duby</id><updated>2010-02-05T23:26:57.0-08:00</updated><summary><![CDATA[
On Wednesday, I noticed Phil Hagelberg's Android-Duby app playground. This piqued my interest for several reasons, but a primary one is the work Phil Bogle is doing to port iLike's Local Concerts app to the Android platform. Many people have found Java's syntax to be too rigid and verbose, and this makes Duby's promise to c...]]>
</summary><content type="html"><![CDATA[
<p>On Wednesday, I noticed Phil Hagelberg's <a href="http://github.com/technomancy/Garrett" title="Garret: A playground for Android Duby development">Android-Duby app playground</a>. This piqued my interest for several reasons, but a primary one is the work Phil Bogle is doing to port <a href="http://www.ilike.com/mobile/concerts">iLike's <em>Local Concerts</em> app</a> to the Android platform. Many people have found Java's syntax to be too rigid and verbose, and this makes <a href="http://github.com/headius/duby">Duby</a>'s promise to convert Ruby-like syntax to JVM bytecode particularly enticing.</p>

<div class="rightImage"><img src="http://threebrothers.org/brendan/blog/closures-in-java-ruby-and-duby/badges.png" alt="Bandit from 'The Treasure of the Sierra Madre'" /><br/><em>Closures? We don't need no stinkin' closures!</em></div>

<p>Having only taken a cursory glance at the concept, we both agreed that Duby would be most useful if it supported Ruby's block syntax. Phil (Bogle) was expressing frustration with Java's lame substitute for closures: the anonymous class. Not only is the construct syntactically and conceptually verbose, but the restriction of scoped access to only final variables is <a href="http://www.cuberick.com/2009/08/anonymous-inner-classes-poor-mans.html">vastly inferior to true closures</a>.</p>

<p>Let's begin with some definitions. For our purposes, closure is <em>not</em> the emotional freedom you achieve after letting go of something big and devastating. Rather, it's a function that is a <em>first-class object</em> &mdash; this means it can be passed and stored as a standard variable &mdash; that is bound to variables in a certain scope. Both Java and Ruby achieve passing by instantiating Objects for new closures.</p>

<p>Examine this contrived example:</p>

<pre><code>public void demo() {
    Runnable r = printClosure("Are we functional yet?");
    r.run();
}

public Runnable printClosure(String text) {
    return new Runnable() {
        public void run() {
            System.out.println(text);
        }
    };
}
</code></pre>

<p>We create the closure, return it, and later call it. Although this looks reasonable, the code actually fails to compile.</p>

<pre><code>Closure.java:14: local variable text is accessed from within inner class; needs to be declared final
                System.out.println(text);
                                   ^
1 error
</code></pre>

<p>To make this work as desired, we need to copy <code>text</code> into a final variable: <code>final String fText = text;</code>. As a side effect, the Java "closure" won't be able to modify variables it refers to or see modifications made to them. But why? The answer lies in the particulars of Java scoping. This instance of <code>Runnable</code> is an anonymous inner class &mdash; it has its own unique scope and limited access to the scopes of other classes. The <code>text</code> variable disappears once the <code>printClosure</code> function returns, so our <code>Runnable</code> can't hang on to it. It also can't really <em>see</em> it &mdash; making it <code>final</code> makes it OK for the value to be read after that scope is being eaten by GC.</p>

<p>But this severely limits the usefulness of passing the function. The following Ruby can't be implemented with Java's anonymous inner class:</p>

<pre><code>#!/usr/bin/env ruby

def make_block
  a = 1
  b = 2
  block = lambda { |x| x + b }
  b = 999 # block sees this change
  return block
end

def run_block(&amp;block)
  puts "first with 1: #{yield 1}"
  eval "b = a", block.binding # block still sees a
  puts "again with 1: #{yield 1}"
end

run_block(&amp;make_block)

# Output:
# first with 1: 1000
# again with 1: 2
</code></pre>

<div class="rightImage"><img src="http://threebrothers.org/brendan/blog/closures-in-java-ruby-and-duby/scope.png" alt="Credit: http://www.flickr.com/photos/doviende/95495500/" title="Credit: http://www.flickr.com/photos/doviende/95495500/" /><br/><em>That's not a scope. <b>This</b> is a scope!</em></div>

<p>See, Ruby's blocks are closures. They are <a href="http://onestepback.org/index.cgi/Tech/Ruby/RubyBindings.rdoc">given the local scope</a> in which they're created. So <code>block</code> can always see and change <code>a</code> and <code>b</code>, and there's only ever one instance of <code>a</code> and <code>b</code>. No duplication. Full access. This let's us create some truly <a href="http://weblog.raganwald.com/2007/01/closures-and-higher-order-functions.html">awesome control structures and higher-order functions</a> that are unimaginable in Java. Ruby does this by always providing a <code>Binding</code> object for the current scope. A closure will copy the current binding and add new local variables to it, leaving the preexisting variables accessible.</p>

<p>A natural question now follows: "Can we do real closures in any JVM language?" Well, actually, yeah. <a href="http://clojure.org/functional_programming#toc2">Clojure does it</a>, and <a href="http://www.scala-lang.org/node/4960">so does Scala</a>. That question was something of a straw man &mdash; a little bit of thought will lead us to conclude that Java's syntax is to blame rather than the machine itself. And as luck would have it, Duby does it too.</p>

<p>However, Duby has one interesting constraint: its compiler can optionally produce either <code>.class</code> or <code>.java</code> files. This places us back within the restrictive confines of Java syntax! Fortunately, the Duby folk have come up with a really neat hack to make the closures work.</p>

<p>The compiler does the following:</p>

<ul>
<li>Creates an anonymous inner class to pass around as the closure.</li>
<li>Creates a <em>second</em> inner class to represent variables shared between the local scope and the closure.</li>
<li>Performs all operations (whether from the closure or in the local scope) on shared variables by accessing them as members of the binding object.</li>
</ul>

<p>The binding object gets to live beyond the life of the local scope since the closure holds on to its reference. It provides public access to its members, so either the local scope or the closure can modify these free variables. Unfortunately, the syntax for writing this is so verbose and fragile that it completely destroys its viability &mdash; unless a compiler like Duby's is producing the code.</p>

<p>For more details, check out <a href="http://kenai.com/projects/duby/pages/DubyBlocks">the DubyBlocks Wiki page</a>.</p>

<p><br style="clear:both;"/></p>
]]>
</content></entry><entry><title>iPad: Falling Short of the Past</title><link href="http://threebrothers.org/brendan/blog/ipad-falling-short-of-the-past/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2010-01-30:/brendan/blog/ipad-falling-short-of-the-past</id><updated>2010-01-30T09:51:51.0-08:00</updated><summary><![CDATA[
 Steve Jobs announced the iPad this week, and technologists have run the gamut of responses. Some people think it will fart rainbows. Some think its reason-defying sorcery and closed software will inveigle unsuspecting hackers into a gloomy extinction. For the most part, however, the response has amounted to a banal whine a...]]>
</summary><content type="html"><![CDATA[
<p>
  <img src="http://threebrothers.org/brendan/images/jobs-ipad.png" alt="Steve Jobs and the iPad" style="float:right;margin:0 0 0 1em;" />
  Steve Jobs announced the iPad this week, and technologists have run the gamut of responses. Some people think it will fart rainbows. Some think its reason-defying sorcery and closed software will <a href="http://al3x.net/2010/01/28/ipad.html" rel="nofollow">inveigle unsuspecting hackers into a gloomy extinction</a>. For the most part, however, the response has amounted to a <a href="http://www.youtube.com/watch?v=lQnT0zp8Ya4" rel="nofollow">banal whine</a> about Flash, multitasking, and maxi pads. Why anyone would complain about <em>not</em> being continually tortured by Flash is beyond me&mdash;but that's another post entirely.
</p>

<p>
  I'm continually led to appreciate the history of Computer Science. I write software for a living, and I've used a number of different languages. I began in O-BASIC, and I've taken an analogous path to the one described by Paul Graham in <em><a href="http://www.paulgraham.com/icad.html" rel="nofollow">Revenge of the Nerds</a></em>:
</p>

<blockquote>
  <p>
    <em>
      If you look at these languages in order, Java, Perl, Python, you notice an interesting pattern. At least, you notice this pattern if you are a Lisp hacker. Each one is progressively more like Lisp. Python copies even features that many Lisp hackers consider to be mistakes. You could translate simple Lisp programs into Python line for line. It's 2002, and programming languages have almost caught up with 1958.
    </em>
  </p>
</blockquote>

<p>
  &quot;Programming languages have almost caught up with 1958.&quot; Something about that really resonates with me, and I don't think it's only because I've been drinking the Lisp-flavored Clojure Kool-Aid. In fact, I'm sure it's not.
</p>

<p>
  I remember the day I had the <acronym title="Model-View-Controller">MVC</acronym> epiphany. I'd worked a little bit in <a href="http://static.springsource.org/spring/docs/2.0.x/reference/mvc.html" rel="nofollow">Spring's framework</a> and had recently dove into the relatively soothing balm of Rails. My prior projects hadn't had any really clean separation. &quot;Man,&quot; I thought, &quot;what a great, new invention. I don't know how people developed web applications before MVC existed.&quot; Then I discovered that <a href="http://heim.ifi.uio.no/~trygver/themes/mvc/mvc-index.html">MVC originated in Xerox PARC in the 70s</a>. Of course, I should have known better&mdash;I had to read all sorts of PARC papers in school. Never underestimate your own capacity to forget important and interesting information.
</p>

<p>
  Here's the interesting thing: we're constantly leaving what's rooted in history and rigor for the technique <em>du jour</em>. Lisp isn't for everyone, but enough incredibly smart people swear by it that it should give you pause. There may be a good alternative to MVC for your application, but chances are you've exchanged it for a fragile pile of highly-coupled, poorly organized classes. You may think it's OK to treat a Java interface like a C header file (yes, I maintained code that had this charming characteristic), but this simply indicates that you don't know the first thing about object-oriented programming.
</p>

<p>
  Now, it would be silly of me to quote <em>Revenge of the Nerds</em> and then make some (de)moralizing point about &quot;industry best practices.&quot; My point thus far is this: for a given problem, it's likely that an efficient and elegant solution exists already (even if only in concept). And very often, it was invented <em>years</em> ago. <b>It is good to be well-versed in the history of your trade.</b> This will help you know how to think about whole classes of problems. And this&mdash;finally&mdash;brings me back to the iPad.
</p>

<p>
  <img src="http://threebrothers.org/brendan/images/parcpad.png" alt="The ParcPad" style="float:left;margin:0 1em 0 0;" />
  Critics are right to be at least a little disappointed, but not due to the likes of Flash or multitasking. The iPhone and iPad are still behind research prototyped at PARC (yes, them again) in the late 80s. Mark Weiser's <a href="http://sandbox.xerox.com/ubicomp/" rel="nofollow">Ubiquitous Computing research</a> conceived of and built a variety of devices for home and office use&mdash;called tabs, pads, and boards&mdash;sized just like iPhones, iPads, and large LCD screens. They even wrote software and built networking devices to stitch the environment together.
</p>

<p>
  It's obvious that Xerox has had a profound impact on Steve Jobs, from the Lisa to the iPhone. When I first heard about the iPhone in 2007, I instantly thought of the ParcTab. Hardware has improved tremendously since the ParcTab experiments and <a href="http://www.ubiq.com/weiser/researchreports.htm" rel="nofollow">papers</a>. Apple now reaps the benefits of faster and cheaper processors, ram, and storage. Wireless networking is pervasive and fast. Screens are vastly better, and touch inputs have obviously improved. The device is supremely capable. But the ubiquitous user interface is completely absent.
</p>

<p>
  I recently advised a nontechnical friend about purchasing an iPhone. She wanted to know how it interfaced with her computer and TV. &quot;It really doesn't,&quot; was my response. But she expected it to. It doesn't take an engineer to see that devices like the iPhone and iPad <em>ought</em> to operate as an extension to the computer or TV. Instead, we have this media syncing model that's reminiscent of some lousy corporate <acronym title="Personal digital assistant">PDA</acronym>. Technology pundits who are quibbling about little features are missing the point: the iPad should have made the jump to seamless, ubiquitous integration. This would have been a technological revolution equivalent to the introduction of the iPhone. This is the next step.
</p>

<p>
  Both the iPhone and the iPad should operate as stand-alone devices. But they could bring so much more power and flexibility if they also acted as extensions to a desktop, laptop, or distributed network. A general-purpose, network-aware, hand-held device that can continue operating without the network. Access this computer and that; give a presentation on this screen; share files with these people; receive and send email; play a game; order lunch&mdash;and use any of your iPhone, iPad, or MacBook at any point in the progression, with the others automatically and wirelessly synced. This is what I expected of Apple.
</p>

<p>
  Indeed, Mark Weiser accurately predicted our current systems in 1996. In <a href="http://www.ubiq.com/hypertext/weiser/acmfuture2endnote.htm">The Coming age of Calm Technology</a>, he describes a transition from the internet and distributed computing to &quot;The <acronym title="Ubiquitous Computing">UC</acronym> Era&quot;&mdash;and he said it would take place between 2005 and 2020. He describes the philosophy of UC with four tenets:
</p>

<ul>
  <li>The purpose of a computer is to help you do something else.</li>
  <li>The best computer is a quiet, invisible servant.</li>
  <li>The more you can do by intuition the smarter you are; the computer should extend your unconscious.</li>
  <li>Technology should create calm.</li>
</ul>

<p>
  This is the standard to which Apple should be held. We're collectively forgetting how good the iPad <em>should</em> be, because we're forgetting how much brilliant computer science research has already been done. Like Java, Perl, and Python, the present incarnation will inch towards superior and older definition. And although I disagree with them philosophically about the openness of their systems to hackers, I believe they will soon reach the ubiquitous computing standard. This will be good for technology all around.
</p>

<p>
  Just remember to peer back a few decades occasionally and recall exactly how much we should expect from modern-day engineering.
</p>

<p>
  <br/>
  <em>
    What has been is what will be,<br/>
    &nbsp;&nbsp;&nbsp;and what has been done is what will be done,<br/>
    &nbsp;&nbsp;&nbsp;and there is nothing new under the sun.
  </em>
  <br/>
  <a href="http://www.gnpcb.org/esv/search/?q=Ecclesiastes+1" rel="nofollow">Ecclesiastes</a>
</p>
]]>
</content></entry><entry><title>Updating gems for Ruby 1.9</title><link href="http://threebrothers.org/brendan/blog/updating-gems-for-ruby-1-9/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2010-01-27:/brendan/blog/updating-gems-for-ruby-1-9</id><updated>2010-01-27T06:41:33.0-08:00</updated><summary><![CDATA[
I recently updated two libraries for Ruby 1.9 compatibility and made them available on Gemcutter. Both of these libraries include hefty C extensions written against the 1.8 headers. After reading Evan Miller's fantastic article on how not to sort by average rating, I really wanted to apply his solution. However, I quickly r...]]>
</summary><content type="html"><![CDATA[
<p>I recently updated two libraries for Ruby 1.9 compatibility and made them available on <a href="http://gemcutter.org" rel="nofollow">Gemcutter</a>. Both of these libraries include hefty C extensions written against the 1.8 headers.</p>

<p>After reading Evan Miller's fantastic article on <a href="http://www.evanmiller.org/how-not-to-sort-by-average-rating.html">how <em>not</em> to sort by average rating</a>, I really wanted to apply his solution. However, I quickly ran into a problem: the magical <span style="font-family:courier new,mono;">statistics2</span> library he used was nowhere to be found. At least, it wasn't available as a gem, and wasn't included in the standard distribution. Wait, you say people actually <a href="http://raa.ruby-lang.org/project/statistics2/" rel="nofollow">shared libraries before RubyGems</a>?! I guess so. I quickly updated the packaging, added Hoe support and released it as a gem&mdash;with <a href="http://github.com/abscondment/statistics2">source on Github</a> and <a href="http://gemcutter.org/gems/statistics2">gem on Gemcutter</a>.</p>

<p>At some point, I needed to do spatial clustering with more points than can comfortably run in a na&iuml;ve linear search. <a href="http://thebogles.com/blog/">Phil Bogle</a> suggested that perhaps a Voronoi diagram could be useful to me, and from this came RubyVor. RubyVor provides efficient calculation of Voronoi diagrams and Delaunay triangulation by wrapping <a href="http://ect.bell-labs.com/who/sjf/">Steven Fortune's C program</a> in a Ruby extension. It too was released as <a href="http://github.com/abscondment/rubyvor">a Github project</a> and a <a href="http://gemcutter.org/gems/rubyvor">Gemcutter gem</a>.</p>

<p>Both the libraries wouldn't compile against 1.9 headers due to changes in basic type structs. The symptom of this problem is messages like the following that spew during extension compilation.</p>

<pre><code>rb_cComputation.c:39: error: 'struct RArray' has no member named 'ptr'
rb_cComputation.c:45: error: 'struct RArray' has no member named 'len'
rb_cComputation.c:284: error: 'struct RFloat' has no member named 'value'
</code></pre>

<p>So what's going on here? Well, the answer is simple: Ruby 1.8 used different C structs; the member values we once accessed directly are no longer where the code thinks they ought to be. Just to illustrate, take a look at the RArray struct:</p>

<pre><code>/* Ruby 1.8 */
struct RArray {
  struct RBasic basic;
  long len;
  union {
    long capa;
    VALUE shared;
  } aux;
  VALUE *ptr;
};

/* Ruby 1.9 */
struct RArray {
  struct RBasic basic;
  union {
    struct {
      long len;
      union {
        long capa;
        VALUE shared;
      } aux;
      VALUE *ptr;
    } heap;
    VALUE ary[RARRAY_EMBED_LEN_MAX];
  } as;
};
</code></pre>

<p>The 1.9 Array has a <em>much</em> more complicated structure. In a 1.8 extension, a programmer would often write things like <span style="font-family:courier new,mono;">RARRAY(a)->ptr</span> to iterate directly over the array via pointers. In 1.9, however, accessing the pointer is more verbose and convoluted. Since this is less than ideal, the Ruby developers simplify things with new macros in 1.9 (<span style="font-family:courier new,mono;">RARRAY_PTR(a)</span> in this case). These also provide nice a level of indirection that can allow the underlying structs to change, but the client code to function without change.</p>

<p>The solution to making these gems compatible with both versions lies in this layer of abstraction: if we can write and use Ruby 1.8 versions of certain 1.9 macros, the code will be struct-agnostic. Below is my fix for RubyVor; it's important to note that structs other than RArray and RFloat also changed, so this isn't a solution for every issue. This is a general pattern that can be used for fixing C-level struct incompatibility. You'll need to figure out the correct 1.8 version of any macros for other structs.</p>

<pre><code>#ifndef RUBY_19
#ifndef RFLOAT_VALUE
#define RFLOAT_VALUE(v) (RFLOAT(v)-&gt;value)
#endif
#ifndef RARRAY_LEN
#define RARRAY_LEN(v) (RARRAY(v)-&gt;len)
#endif
#ifndef RARRAY_PTR
#define RARRAY_PTR(v) (RARRAY(v)-&gt;ptr)
#endif
#endif
</code></pre>

<p>Now that I use these three macros instead of direct member access, these extensions are compatible with both Ruby versions. So have fun triangulating and crunching statistics in Ruby 1.9!</p>
]]>
</content></entry><entry><title>Solving cryptograms in Clojure</title><link href="http://threebrothers.org/brendan/blog/solving-cryptograms-in-clojure/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2009-12-31:/brendan/blog/solving-cryptograms-in-clojure</id><updated>2009-12-31T10:33:07.0-08:00</updated><summary><![CDATA[
 While working on Project Euler, I discovered Peter Norvig's elegant Sudoku solver implementation. Although the associated TDD discussion brought me much humor, it was the efficacy and flexibility of constraint propagation and search that really stuck with me. As I implemented this solver in Clojure, I had a small epiphany:...]]>
</summary><content type="html"><![CDATA[
<p>
  While working on <a href="http://projecteuler.net/index.php?section=problems&amp;id=96" rel="nofollow">Project Euler</a>, I discovered Peter Norvig's elegant <a href="http://norvig.com/sudoku.html">Sudoku solver</a> implementation. Although the associated <a href="http://ravimohan.blogspot.com/2007/04/learning-from-sudoku-solvers.html" rel="nofollow"><acronym title="Test-driven development">TDD</acronym> discussion</a> brought me <a href="http://pindancing.blogspot.com/2009/09/sudoku-in-coders-at-work.html" rel="nofollow">much humor</a>, it was the efficacy and flexibility of constraint propagation and search that really stuck with me. As I implemented this solver in Clojure, I had a small epiphany: one could also model <a href="http://en.wikipedia.org/wiki/Cryptogram" rel="nofollow">cryptograms</a> as a constraint problem and find a solution in a nearly identical manner. Here is my account of implementing such a solution.
</p>

<h2>Formulation</h2>

<p>
  The problem is rather different than Sudoku. In some ways, it's simpler: we don't need to figure out which rows, columns, and boxes are affected by each state change. That eliminates a lot of bookkeeping, which is fortunate; figuring out how to compare a set of partially decrypted words to see whether they match an encrypted word and the current puzzle state is enough of a hassle.
</p>

<p>
  I want to list the possible solutions for an encrypted word, and then use search and constraint propagation to eliminate these possibilities. To find the solution list, I'll convert each word into what I term its <em>base form</em>. This is done by replacing each character with a representation of its order of appearance. For example, both "seas" and "that" become "ABCA". Using integers naturally limits this technique to words with 10 or fewer distinct characters, so I have opted to use upper-case characters instead. To make a comprehensive list, I group all words in <span style="font-family:courier new,mono;font-size:0.8em;">/usr/share/dict/words</span> by their base form to create a dictionary keyed on base forms. We can then look up candidate solutions using the base form for any encrypted word. This solution is similar to the one required by the ever popular <a href="http://www.google.com/search?q=anagram+interview+question" rel="nofollow">anagram interview question</a>. It quite naturally introduces a limitation to our solver; namely, in order to decrypt a word it must appear in the computer's word list. I find this list on a standard *NIX distribution to be quite sufficient.
</p>

<p>
  In Clojure, a single entry in the base form dictionary looks something like this:
</p>

<p style="font-family:courier new,mono;font-size:0.8em;margin-left:2em;">
  {"ABBABC" ["beebes" "inning" "peeped" "peeper" "teeter"]}
</p>

<p>
  When an encrypted word has only one candidate on its list, we can consider it solved and propagate that choice. If we encounter a state where an encrypted word has an empty candidate list, we know we've propagated impossibly conflicting constraints. Unlike the Sudoku problem, simply maintaining a list of potential valid states isn't enough. We really need to store a list of all applied decryption rules, and use them as follows.
</p>

<h2>Rules and eliminating candidates</h2>

<p>
  Say we have the following encrypted word/candidate list with some yet-to-be-applied rules:
</p>

<p style="font-family:courier new,mono;font-size:0.8em;margin-left:2em;">
  ;;; Candidates<br/>
  ("vkkvkl" ["beebes" "inning" "peeped" "peeper" "teeter"])<br/><br/>
  ;;; New rules<br/>
  {\v \p}
</p>

<p>
  The new rules say we should translate every encrypted "v" to a "p". We can integrate this into the base form and generate a partially decrypted base form for the encrypted word. We can then use that to further eliminate candidates.
</p>

<p style="font-family:courier new,mono;font-size:0.8em;margin-left:2em;">
  ;;; New base form for "vkkvkl", given our rules<br/>
  "pBBpBC"<br/><br/>
  ;;; New hybrid base forms for existing candidates<br/>
  ["ABBABC" "ABBABC" "pBBpBC" "pBBpBC" "ABBABC"])<br/><br/>
  ;;; New candidates<br/>
  ("vkkvkl" ["peeped" "peeper"])
</p>

<h2>Propagation</h2>

<p>
  Propagating the constraints is straightforward. We follow four simple rules:
</p>

<ol>
  <li>If any encrypted word has no candidates, we are in an inconsistent state. Return nil.</li>
  <li>Otherwise, if <em>all</em> words have only one candidate, return. We've found a solution!</li>
  <li>Otherwise, if any encrypted word has only one candidate, accept that candidate as a solution. Update the existing rules in light of this solution and apply them to all the other candidates recursively.</li>
  <li>Otherwise, return what we have so far &mdash; all words still have more than one candidate, so we have deduced all that we can. We'll fall back on search to progress further.</li>
</ol>

<h2>Search</h2>

<p>
  Now that we have the basic tools for modeling and enforcing the constraints, we can easily write a function to fully apply given rules to a set of candidates.
  However, as seen above in point 4, we can encounter a state where we've eliminated some candidates but have not found a solution. Indeed, this is the <em>initial</em> problem state. In order to begin (and later to progress), we need to choose an encrypted word and one of its candidates and run with that pair. If it's an invalid pairing, we will reach an inconsistent state and backtrack to try the next pairing. This is a basic depth-first search. Our search will return the first valid result (where "valid" means all encrypted words are solved). We can optimize the search by always starting with first candidate of whichever <em>unsolved</em> encrypted word has the fewest number of candidates &mdash; this trims the search tree fairly well. We can also ensure that the set of decryption rules is actually changed by a given candidate before attempting to search further.
</p>

<h2>Concluding thoughts</h2>

<p>
  Cryptograms often have many, many solutions. The first solution found by search is often <em>not</em> the most correct one &mdash; especially in terms of human language. There are some things that could be done in the search function to improve the chance of correctness: e.g. picking the next candidate by word/letter frequency. A more advanced system could use some <acronym title="Natural Language Processing">NLP</acronym> techniques to determine whether the decrypted solution passed as human language. All of these are moot, considering that the benefit provided wouldn't outweigh complexity they would add to this simple algorithm.
</p>

<h3>Caveat developer</h3>

<p>
  I'm providing my implementation as a reference. Given that I'm a novice Clojurer, it's liable to be hideous and non-idiomatic. I found working in Clojure to be extremely satisfying, both for this project and for the Sudoku one. My solution is a mere 132 lines (whitespace/comments included), so this is obviously a very expressive language.
  I've been very impressed by flexibility of its <a href="http://technomancy.us/132">persistent data structures</a> and its <a href="http://clojure.org/lazy" rel="nofollow">lazy evaluation</a>. These make it a very powerful language, and it's definitely a tool I want to sharpen.
</p>

<p><a href="/files/cryptogram.clj">cryptogram.clj</a></p>
]]>
</content></entry><entry><title>Oh, by the way: Baby!</title><link href="http://threebrothers.org/brendan/blog/baby/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2008-08-14:/brendan/blog/baby</id><updated>2008-08-14T11:09:00.0-08:00</updated><summary><![CDATA[
Since threebrothers.org has been down for a while, I missed some very important things. One month and one day ago, Jessica gave birth to Ezra Wray Ribera. I have a son! There are a bunch of pictures up on Flickr: http://flickr.com/photos/bribera/tags/ezra. That is all. ...]]>
</summary><content type="html"><![CDATA[
<p>Since threebrothers.org has been down for a while, I missed some very important things.  One month and one day ago, <a href="http://jeskybera.blogspot.com/2008/07/baby-formerly-known-as-spud.html">Jessica gave birth to Ezra Wray Ribera</a>.  I have a son!</p>

<p><img src="http://farm4.static.flickr.com/3085/2730011801_0b6c13dd9d.jpg" alt="Ezra Wray Ribera" /></p>

<p>There are a bunch of pictures up on Flickr: <a href="http://flickr.com/photos/bribera/tags/ezra">http://flickr.com/photos/bribera/tags/ezra</a>.  That is all.</p>
]]>
</content></entry><entry><title>Copyright Progress</title><link href="http://threebrothers.org/brendan/blog/copyright-progress/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2008-08-13:/brendan/blog/copyright-progress</id><updated>2008-08-13T10:29:00.0-08:00</updated><summary><![CDATA[
I was excited to read this morning that the Court of Appeals has upheld an open-source copyright license. To quote Lawrence Lessig's summary: In non-technical terms, the Court has held that free licenses such as the CC licenses set conditions (rather than covenants) on the use of copyrighted work. When you violate the condi...]]>
</summary><content type="html"><![CDATA[
<p>I was excited to read this morning that <a href="http://lessig.org/blog/2008/08/huge_and_important_news_free_l.html">the Court of Appeals has upheld an open-source copyright license</a>.  To quote Lawrence Lessig's summary:</p>

<blockquote><em>In non-technical terms, the Court has held that free licenses such as the CC licenses set conditions (rather than covenants) on the use of copyrighted work. When you violate the condition, the license disappears, meaning you're simply a copyright infringer. This is the theory of the GPL and all CC licenses. Put precisely, whether or not they are also contracts, they are copyright licenses which expire if you fail to abide by the terms of the license.</em></blockquote>

<p>It's wonderful when things work the way they're designed.</p>

<p>Update: Groklaw has <a href="http://www.groklaw.net/article.php?story=2008081313212422">some additional information</a>.</p>

<p>Another update: In another area of the copyright arena, Stanford's <acronym title="Center for Internet and Society">CIS</acronym> has succeeded in obtaining a ruling from the New York Supreme Court <em>rejecting</em> the idea that is <a href="http://cyberlaw.stanford.edu/node/5833">no de minimis use for recordings</a> (again <a href="http://lessig.org/blog/2008/08/and_another_big_win_today_for.html">via lessig.org</a>).  Woot!</p>
]]>
</content></entry><entry><title>Verizon Filters Ports 80 and 25</title><link href="http://threebrothers.org/brendan/blog/verizon-filters-ports-80-and-25/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2008-08-11:/brendan/blog/verizon-filters-ports-80-and-25</id><updated>2008-08-11T15:52:00.0-08:00</updated><summary><![CDATA[
The gracious hosts of this server have recently upgraded to Verizon FiOS, which should have been a great boon to threebrothers.org; however, Verizon filters ports 80 and 25. This is why, dear reader, I have reconfigured my blog to live on port 8080. Apparently, these ports are only used for &quot;business purposes&quot;, an...]]>
</summary><content type="html"><![CDATA[
<p>The gracious hosts of this server have recently upgraded to Verizon <acronym title="Fiber Optic Service">FiOS</acronym>, which should have been a great boon to threebrothers.org; however, Verizon filters ports 80 and 25.  This is why, dear reader, I have reconfigured my blog to live on port 8080.  Apparently, these ports are only used for &quot;business purposes&quot;, and businesses need to pay more.  While I now have more bandwidth, I am also greatly impaired in my ability to use it.</p>

<p>This further polarizes my beliefs about business rules and technology, which can be summarized as, "don't interfere, you incompetent nincompoops!"  I could spend an inordinate amount of time and energy dissecting the various facets of idiocy I have uncovered attempting to obtain an <acronym title="Internet Service Provider">ISP</acronym> at my new apartment.  To peel back the layers of tampering, throttling, and filtering from this proverbial onion would make even the most stalwart vegetable cutter cry.  I read through the fine, disingenuous print of each company's <acronym title="Terms of Service">TOS</acronym>, and each time it is like turning on the shower and receiving a cascade of putrescent sewage.  Each one of these companies is a moldering, pus-filled lesion on the face of the internet.</p>

<p>So, please: clean up your acts.  Bandwidth should not be accompanied by throttles, filters, or intermittent magical interference.  If I have a service plan advertised at a speed of 3.0 megabits per second, I expect:</p>

<ol>
  <li>That this speed is consistent &mdash; it doesn't change unless there is a <em>problem</em> with the service, and problems ought not to be expected.</li>
  <li>The bandwidth I purchase can be used across the entirety of the <a href="http://en.wikipedia.org/wiki/OSI_model"><acronym title="Open Systems Interconnection Basic Reference Model">OSI model</acronym></a>. This means no monkeying with anything &mdash; very similar to the consistency requirement from point 1.</li>
  <li>Since there are 2,592,000 seconds in a 30-day period, I expect to be able to download approximately 949.22 gigabytes of data in a 30-day period.  Of course, the same &quot;problems&quot; disclaimer applies here &mdash; of course I don't expect <a href="http://en.wikipedia.org/wiki/Myth_of_the_nines">5 nines</a> of uptime, or even 3.</li>
</ol>

<p>Postscript:</p>

<p>I'm aware that Verizon is the only brand with which I am associating this vituperation, and I don't think that's entirely fair.  Verizon's port filtering leans towards the innocuous end of the moldering, pus-filled lesion spectrum &mdash; it's a few orders of magnitude less despicable than some of the despicable things being done by ISPs.  However, it happens to be the particular lesion that I am faced with looking at, and so I will not forgo associating their name with their actions.</p>
]]>
</content></entry><entry><title>There and back again: the return to Linux (updated)</title><link href="http://threebrothers.org/brendan/blog/there-and-back-again-the-return-to-linux/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2008-05-21:/brendan/blog/there-and-back-again-the-return-to-linux</id><updated>2008-05-21T21:55:00.0-08:00</updated><summary><![CDATA[
When I started at iLike in October, I chose a MacBook Pro as my development machine. After months of my attempting to adapt to OSX, that Macbook is now running Linux. Macs have always been lauded for their superior usability; while I can corroborate this sentiment with respect to Windows' UI, I consistently found OSX cloyin...]]>
</summary><content type="html"><![CDATA[
<p>When I started at <a href="http://ilike.com/user/brendanribera">iLike</a> in October, I chose a MacBook Pro as my development machine.  After months of my attempting to adapt to OSX, that Macbook is now running Linux.  Macs have always been lauded for their superior usability; while I can corroborate this sentiment with respect to Windows' <acronym title="User Interface">UI</acronym>, I consistently found OSX cloying and claustrophobia-inducing when compared to a standard Linux environment.  So I nuked it.</p>

<p>Here are some interesting things I learned in the process:</p>

<ul>
  <li>OSX relies on a ~200MB EFI system partition.  The MacBook's BIOS looks for this partition <em>everywhere</em> before performing a standard boot from the hard drive's <acronym title="Master Boot Record">MBR</acronym>.  There are two "gotchas" as a result of this silly operating system <acronym title="Digital Rights Management">DRM</acronym>:
    <ol>
      <li>If you want to dual boot with <em>any</em> other operating system, you have to use a proprietary program from within OSX to write to the EFI partition.  This isn't that hard, since the program works well and nearly all of the online documentation instructs the user to perform this method.<br/><br/></li>
      <li>If you're like me and you don't want to dual boot, you have to set an MSDOS disklabel on the hard drive's first partition and make it bootable before the MacBook's BIOS will attempt to boot it.  I found that at one of the few sites referring to <a href="http://slu.ms/articles/ubuntu-linux-on-the-macbook">booting only Linux on a MacBook</a>.  Additionally, booting will involve ~20 seconds of annoying white screen while the MacBook's BIOS searches desperately for the missing EFI partition.<br/><br/></li>
    </ol>
  </li>
  <li>Since the MacBook has a Core 2 Duo, you can install the poorly-named AMD64 branch of whatever distribution you're using.  If you happen to install Ubuntu like I did, peruse the <a href="http://ubuntuforums.org/forumdisplay.php?s=e33b9a6ef38cfc8fadd59b78fb2e8c18&amp;f=343">x86 64-bit Users Ubuntu forum</a> to get abreast of any odd architecture-related issues.  Since many programs (Firefox and Thunderbird, for example) are 32-bit, it's important to get all of the necessary 32-bit compatibility libraries installed.<br/><br/>In Ubuntu, lacking these libraries means that a fresh download of Firefox or Thunderbird won't be able to access the internet &mdash; lame.  To solve, install <tt>lib32nss-mdns</tt> (ala <a href="http://ubuntuforums.org/showthread.php?t=796225">this thread</a>).</li>
</ul>

<p><b>Update:</b> <a href="http://thenullpointer.net">Dustin</a> asks what my particular complaints are.  Well, here goes...</p><div>&lt;joking&gt;<ul style="margin-top:0;margin-bottom:0;padding-top:0;padding-bottom:0;"><li style="margin-top:0;margin-bottom:0;padding-top:0;padding-bottom:0;">The missing right-hand mouse button</li></ul>&lt;/joking&gt;<br/><br/></div><p>Seriously, though; it was a combination of these things:</p>

<ul>
  <li>The crazy focus model: you can't actually click on a control inside a window unless that window already has focus.<br/><br/>Imagine that Thunderbird has the focus and is sitting in one of two monitors; if I want to view a different tab in the instance of Firefox that sits on the other monitor (Firefox is visible, but doesn't have focus), I have to click twice: once to attain focus, once to actually click the tab I want to view.<br/><br/></li>
  <li>Shortcut keys.  I know, everything can be changed; it's just ridiculous to have to go through and reset all of the defaults<br/><br/></li>
  <li>1-dimensional desktop.<br/><br/>I didn't have <a href="http://www.apple.com/macosx/features/spaces.html">Leopard and its "Spaces"</a>, which would probably have scratched this itch.  But I've really grown to be <em>dependent</em> on Compiz and all of the little ways you can customize it.  Even with Spaces, you just don't have the same degree of granularity that Compiz offers.  Plus, I'll add the totally emotional, worthless argument that Spaces is an obvious knock-off of Compiz since Linux desktops have been doing this for a good long while.<br/><br/></li>
  <li>Performance &mdash; both mine and the machine's.<br/><br/>OSX can't keep up with a well-tuned Linux installation.  Sure, both Linux and OSX can run laps around your year-old, bloated Windows installation.  Nevertheless, I kept getting frustrated with how things would freeze up.  Windows has the <acronym title="Blue Screen Of Death">BSOD</acronym>; OSX has the <acronym title="Beach Ball of Frustration">BBOF</acronym>.<br/><br/>Additionally, my own performance was suboptimal under OSX.  Perhaps if I had made a complete switch (and not retained my Linux <em>skillz</em> by using it at home and work every day) I would have adapted; as it is, I kept on tripping on these and other subtle UI differences.<br/><br/></li>
  <li>In general, Linux is a much more developer-friendly environment.  I find it faster to set up, and faster to alter.  That has to do with personal preference and knowledge more than anything else.</li>
</ul>
]]>
</content></entry><entry><title>Grep and Subversion</title><link href="http://threebrothers.org/brendan/blog/grep-and-subversion/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2008-05-16:/brendan/blog/grep-and-subversion</id><updated>2008-05-16T15:38:00.0-08:00</updated><summary><![CDATA[
A while ago, Grant supplied a nice shell hack for recursively grepping through a subversion enlistment while ignoring the .svn directory contents. This was the solution to a thread about counting the number of occurrences of a given word (HACK, in this case) within your project; the final response did this rather nicely. I'...]]>
</summary><content type="html"><![CDATA[
<p>A while ago, <a href="http://twitter.com/grantr">Grant</a> supplied a nice shell hack for recursively grepping through a subversion enlistment while ignoring the .svn directory contents.  This was the solution to a <a href="http://twitter.com/laurelfan/statuses/774697353">thread</a> about <a href="http://twitter.com/abscondment/statuses/774699294">counting</a> the number of occurrences of a given word (HACK, in this case) within your project; <a href="http://twitter.com/grantr/statuses/774701774">the final response</a> did this rather nicely.</p>

<p>I've found myself wanting to needing this more and more: searching for all instances in which a certain method is called, for all uses of a particular phrase, for all uses of a <acronym title="Cascading StyleSheets">CSS</acronym> class, <em>et cetera</em>.  And <a href="http://www.hhhh.org/wiml/virtues.html">like a good programmer</a>, I have consistent trouble actually typing out all of those commands and flags.  Whether it's my memory or merely my lazy fingers matters not; I needed this to be encapsulated as a shell script that I could call just like grep.</p>

<p>Here's my condensed version.  I know some distributions include an 'rgrep' by default; since that name was available on both of mine, I simply took it.  Note that I appended the <em>.sh</em> extension so that I could easily force my web server to spit it out as text/plain &mdash; in my actual environment, it's just <em>rgrep</em>, and is stuck into a PATH-friendly directory for easy use.</p>

<p><a href="http://threebrothers.org/brendan/blog/files/rgrep.sh">rgrep.sh</a></p>

<p>Usage: rgrep &lt;pattern&gt; &lt;directory&gt; &lt;grep arguments&gt;</p>
]]>
</content></entry><entry><title>A modern-day seekdir() bug that's older than me</title><link href="http://threebrothers.org/brendan/blog/a-modern-day-seekdir-bug-thats-older-than-me/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2008-05-15:/brendan/blog/a-modern-day-seekdir-bug-thats-older-than-me</id><updated>2008-05-15T16:23:00.0-08:00</updated><summary><![CDATA[
Take a gander at Fixing seekdir(), an account of quashing a bug in the BSD directory libraries. This is a very interesting piece of UNIX history, and probably still exists in the most recent versions of Apple's OSX. My favorite part? =========================== 4.1 c.1 ======================================= /* Copyright (c...]]>
</summary><content type="html"><![CDATA[
<p>Take a gander at <a href="http://www.vnode.ch/fixing_seekdir">Fixing seekdir()</a>, an account of quashing a bug in the <acronym title="Berkley Software Distribution">BSD</acronym> directory libraries.  This is a very interesting piece of UNIX history, and probably still exists in the most recent versions of Apple's OSX.</p>

<p>My favorite part?</p>

<pre><code>=========================== 4.1 c.1 =======================================
/* Copyright (c) 1982 Regents of the University of California */
</code></pre>

<p>That's right &mdash; this bug has been lurking <em>since 1982</em>.</p>
]]>
</content></entry><entry><title>Firefox 2 to 3: A Cautionary Tale</title><link href="http://threebrothers.org/brendan/blog/firefox-2-to-3-a-cautionary-tale/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2008-05-07:/brendan/blog/firefox-2-to-3-a-cautionary-tale</id><updated>2008-05-07T08:23:00.0-08:00</updated><summary><![CDATA[
I've been using Firefox Beta 3 whenever I can, and I've really enjoyed it. It has huge gains over Firefox 2 and Internet Explorer in the area of memory consumption, and that makes me really happy. Firefox 2.x was fun and all, but it didn't really shine over the 1.x series in the ways that I hoped it would. Combine that lack...]]>
</summary><content type="html"><![CDATA[
<p>I've been using <a href="http://www.mozilla.com/en-US/firefox/all-beta.html">Firefox Beta 3</a> whenever I can, and I've really enjoyed it.  It has <em>huge</em> gains over Firefox 2 and Internet Explorer in the area of memory consumption, and that makes me really happy.  Firefox 2.x was fun and all, but it didn't really shine over the 1.x series in the ways that I hoped it would.  Combine that lack-of-notable-improvement with its piggish memory usage, and one could be questioning one's faith in Mozilla rather often.  I kept thinking to myself, "Man, I hope they work on this in the next release."</p>

<p>So, when the Beta came out and was being lauded for its memory leak improvements, I jumped at it.  And man, was it better!  But of course, the nifty extensions that I've come to rely on at work (Firebug in particular) haven't yet been released for the 3.x branch.  So (on my home laptop, at least), I find myself switching between the old and new rather often.</p>

<p>The caution: <b>make sure to keep separate .mozilla directories for your different versions</b>!</p>

<p>After a while of switching back and forth, I found <em>both</em> copies to be horribly slow.  Using any form elements, clicking any links, and even attempting to type a new URL into the address bar caused Firefox to eat CPU cycles like nobody's business.  So, while I was really pleased that it used less memory, my sloppy switching techniques turned it into an unusable mess.  By deleting everything and storing separate directories (.mozilla2 and .mozilla3, with the active one symlinked as .mozilla), I seem to have resolved the issue for both versions.  Whew!</p>
]]>
</content></entry><entry><title>Death by Duck-Typing</title><link href="http://threebrothers.org/brendan/blog/death-by-duck-typing/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2008-05-01:/brendan/blog/death-by-duck-typing</id><updated>2008-05-01T10:48:00.0-08:00</updated><summary><![CDATA[
 Ruby is all about the duck-typing. Most of the time, I am too. But sometimes, it can lead to some very confusing and very nasty issues. Suppose you get a variable, h, from someone's cool helper function, and with it you want to build up a hash of Widgets. You have millions and billions of Widgets in your database, but you'...]]>
</summary><content type="html"><![CDATA[
<p><img src="http://threebrothers.org/brendan/blog/files/duckt.gif" alt="Duckbot" style="border:0 0 0 1em;float:right;" /></p>

<p>Ruby is all about the duck-typing.  Most of the time, I am too.  But sometimes, it can lead to some very confusing and very nasty issues.</p>

<p>Suppose you get a variable, <b>h</b>, from someone's cool helper function, and with it you want to build up a hash of Widgets.  You have millions and billions of Widgets in your database, but you're only dealing with the most recently added ones.  So you do something like this:</p>

<pre><code>h = get_my_h_now()
# Get the 50 widgets with the highest ids and stick them into h
Widget.find(:all, :limit =&gt; 50, :order =&gt; 'id DESC').map {
  |w| h[w.id] = w
}
</code></pre>

<p>Pretty innocuous, right?  I mean, if the code works without errors, it's all good... right?  Right?</p>

<p>What if the cool helper function you're using doesn't do quite what you expect it to do?  Let's say you're expecting a <code>Hash</code>, but it gives you an <code>Array</code>.  Aw, buckets!  The joy of duck-typing: Your code will still work.  The curse of duck-typing: <em>Your code will still work</em>.  That's right &mdash; treat <code>h</code> as a black box, and (when keying off of your model's id) the outputs are the same.  It quacks just fine... so what's the problem? What do you suppose the following code outputs?  Oh, and please: don't run this snippet in irb; use the actual ruby interpreter or you'll never finish reading this article.</p>

<pre><code>widget = {
  :id =&gt; 123456789,
  :type =&gt; 'Really cool',
  :price =&gt; 999.99
}
id = widget[:id]
h = []
m = `ps -o rss= -p #{Process.pid}`.to_i
puts "Using #{m}kb"
h[id] = widget
puts "Memory costs $#{h[id][:price]} per what???"
m = `ps -o rss= -p #{Process.pid}`.to_i
puts "Using #{m}kb"
</code></pre>

<p>(hat tip to Laurel Fan for the succinct <a href="http://laurelfan.com/2008/1/15/ruby-memory-usage" rel="external">ruby memory usage</a> syntax)</p>

<p>Surprised by the results?</p>

<pre><code>Using 1632kb
Memory costs $999.99 per what???
Using 483960kb
</code></pre>

<p>Yikes!  How did storing one little Widget suck up more than 470 megabytes of RAM?  The answer is all in the value of <b>id</b> and the nature of Ruby's arrays.  Ruby offers many convenient-yet-dangerous pieces of functionality (duck-typing, for one).  <code>Array</code> has a particular piece of dangerous convenience: dynamic allocation.  You can address positions on an <code>Array</code> that are larger than its current size, and the <code>Array</code> will dynamically resize itself to accommodate.  This is only dangerous because Ruby's <code>Array</code>s are not sparse; that is to say, when you address position 1,000,000 on a freshly created <code>Array</code>, Ruby has to allocate and store 1,000,000 nils and all of the pointer and class overhead associated with those nils.</p>

<p>So when you take a widget with id 123,456,789 and attempt to store it, using its id as the position... whew!  Ruby definitely has its work cut out for it, since you'll get over its <a href="http://viewsourcecode.org/why/hacking/theFullyUpturnedBin.html" rel="external">initial 8-megabyte heap</a> very quickly.  If you do this sort of thing in Rails and you have many requests processing at the same time, your servers will be in swap death pretty quickly.  Chances are high that you won't catch an issue like this when using a development database with low-id Models, since you'll be addressing much lower positions.</p>

<p>To be sure, duck-typing isn't the only perpetrator in this example: <code>Array</code> can take a good share of the blame, too.  However, we never would have got into this situation if it were impossible to attempt to address an <code>Array</code> when intending to address a <code>Hash</code>.  I still enjoy the looseness of Ruby, and (at this point) wouldn't trade it for the extra security of strict typing &mdash; it's just important to make sure that the quack you produce is the one which you intended.</p>
]]>
</content></entry><entry><title>The Bearded Coincidence</title><link href="http://threebrothers.org/brendan/blog/the-bearded-coincidence/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2008-04-18:/brendan/blog/the-bearded-coincidence</id><updated>2008-04-18T09:58:00.0-08:00</updated><summary><![CDATA[
Herman Melville is my favorite author, hands down. I could describe his writing like a fine wine: it's dark and complex, full of subtlety and nuance; it's full-bodied and has an incredibly long finish. I'll have a lot more to say about Herman Melville in a few weeks. I'm at the beginning of The Confidence-Man, the awesomene...]]>
</summary><content type="html"><![CDATA[
<p>Herman Melville is my favorite author, hands down.  I could describe his writing like a fine wine: it's dark and complex, full of subtlety and nuance; it's full-bodied and has an incredibly long finish.</p>

<p>I'll have a lot more to say about Herman Melville in a few weeks.  I'm at the beginning of <a href="http://en.wikipedia.org/wiki/The_Confidence-Man">The Confidence-Man</a>, the awesomeness of which <a href="http://cuttheknot.blogspot.com/2008/04/ralph-waldo-ellison-and-herman-melville.html">I've heard about</a> and am now experiencing first-hand.  In the meantime, I'd just like to point out the uncanny resemblance between Sam Beam of <a href="http://ilike.com/artist/Iron+%2526+Wine">Iron &amp; Wine</a> and Mr. Melville:</p>

<p><img src="http://threebrothers.org/brendan/blog/files/ironandwine.jpg" style="float:right;" alt="Iron &amp; Wine"/><img src="http://threebrothers.org/brendan/blog/files/melville.jpg" alt="Herman Meville" style="float:left;"/><br style="clear:both;"/></p>
]]>
</content></entry><entry><title>Good reasons to work from home</title><link href="http://threebrothers.org/brendan/blog/good-reasons-to-work-from-home/" rel="alternate" type="text/html" /><id>tag:threebrothers.org,2008-03-26:/brendan/blog/good-reasons-to-work-from-home</id><updated>2008-03-26T13:25:00.0-08:00</updated><summary><![CDATA[
 Jessica spoils me. ...]]>
</summary><content type="html"><![CDATA[
<p><img src="http://threebrothers.org/brendan/blog/files/reason1.jpg" alt="Reason #1" /></p>

<p><img src="http://threebrothers.org/brendan/blog/files/reason2.jpg" alt="Reason #2" /></p>

<p><a href="http://jeskybera.blogspot.com">Jessica</a> spoils me.</p>
]]>
</content></entry></feed>